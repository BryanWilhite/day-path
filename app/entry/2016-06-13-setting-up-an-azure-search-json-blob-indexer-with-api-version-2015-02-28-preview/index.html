<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <meta name="description" content="my technical Blog ✒ for my studio" />
        <meta name="robots" content="index, follow" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <meta name="google-site-verification" content="MyXJp0qYgoTSi472GCarwPFWqvRZAo8khVV_FXV33tI" />
        <meta name="msvalidate.01" content="9C08B066B4967EBE515E0CC7C146DE30" />

        <base href="http://songhayblog.azurewebsites.net/" />

        <link rel="canonical" href="http://songhayblog.azurewebsites.net/" />
        <link rel="alternate" type="application/atom+xml" title="day path" href="/entry/feed.xml" />
        <link rel="SHORTCUT ICON" href="http://songhayblog.azurewebsites.net/image/favicon.ico" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
        <link href="http://songhayblog.azurewebsites.net/style/styles.min.css" rel="stylesheet" />

        <script src="http://songhayblog.azurewebsites.net/script/index.min.js"></script>

        <title>Setting up an @Azure Search JSON blob Indexer with api-version=2015-02-28-Preview - day path</title>
    </head>

    <body class="mdc-typography">
        <header class="mdc-top-app-bar mdc-top-app-bar--short">
            <div class="mdc-top-app-bar__row">
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                    <a href="http://songhayblog.azurewebsites.net/" class="material-icons mdc-top-app-bar__navigation-icon">first_page</a>
                    <span class="mdc-top-app-bar__title">day path</span>
                </section>
                <section class="description mdc-top-app-bar__section mdc-top-app-bar__section--align-end">
                    my technical Blog ✒ for my studio
                </section>
            </div>
        </header>
        <main class="mdc-layout-grid" id="main-content">
            <section class="entry">

    <h1>Setting up an @Azure Search JSON blob Indexer with api-version=2015-02-28-Preview</h1>
<p>I would like to thank <a href="https://twitter.com/chaosrealm4">Microsoft’s Eugene Shvets</a> for helping me out with setting up Azure Search for JSON blobs. What I am going to write here should be available <em>visually</em> in the Azure Portal soon after June 2016. I am going to share a few RESTful OData-flavored calls using an old shoe in the .NET closet called <code>HttpWebRequest</code>. To further reveal how old I am, kids, I am going to use <a href="https://msdn.microsoft.com/en-us/library/hh598957.aspx">Visual Studio Test</a> (to “confuse” you) in all of my code samples.</p>
<p>Once we use these REST calls to get search working, we can use the Azure Portal to run test searches. This is what it looks like:
<a href="https://www.flickr.com/photos/wilhite/26980553034/in/dateposted-public/" title="Azure Search of JSON Blobs"><img alt="Azure Search of JSON Blobs" src="https://farm8.staticflickr.com/7294/26980553034_89827d84d4_z_d.jpg"></a></p>
<p>There are three ‘components’ to get Azure search working:</p>
<ul>
<li>Data Source (of type <code>azureblob</code>)</li>
<li>Index (without a default field key of <code>id</code>)</li>
<li>Indexer (with configuration parameter <code>useJsonParser = true</code>)</li>
</ul>
<p>As of today, it is not possible to use the Azure Portal to generate an <code>azureblob</code> Data Source. It is also not possible to use the Portal to get an Indexer—and, while it <em>is</em> possible to get an Index in the Portal, it will have a default key of <code>id</code> which I cannot change in the UI. So, it’s best to make REST calls—likely the *same *calls made from the Portal.</p>
<h2>Learn to DELETE and GET a search ‘component’ before generating it…</h2>
<p>I am not a Test-Driven Development type of guy but I do have opinions and I like to be as clean and neat as possible. All of these quirks drive me to mention the need to <code>DELETE</code> the things I <code>POST</code> to Azure for the need to undo any mistake I might make. So here is my “confusing” way to <code>DELETE</code>:</p>
<pre><code class="language-c#">[TestCategory(&quot;Integration&quot;)]
[TestMethod]
[TestProperty(&quot;apiBase&quot;, &quot;https://my-azure.search.windows.net&quot;)]
[TestProperty(&quot;apiKey&quot;, &quot;[copy and paste from Portal]&quot;)]
[TestProperty(&quot;apiTemplate&quot;, &quot;{componentName}/{itemName}?api-version=2015-02-28-Preview&quot;)]
[TestProperty(&quot;componentName&quot;, &quot;indexers&quot;)]
[TestProperty(&quot;itemName&quot;, &quot;songhayblog-indexer&quot;)]
public void ShouldDeleteAzureSearchServiceComponent()
{
    var projectRoot = this.TestContext.ShouldGetProjectsFolder(this.GetType());
    #region test properties:
    var apiBase = this.TestContext.Properties[&quot;apiBase&quot;].ToString();
    var apiKey = this.TestContext.Properties[&quot;apiKey&quot;].ToString();
    var apiTemplate = new UriTemplate(this.TestContext.Properties[&quot;apiTemplate&quot;].ToString());
    var componentName = this.TestContext.Properties[&quot;componentName&quot;].ToString();
    var itemName = this.TestContext.Properties[&quot;itemName&quot;].ToString();
    #endregion
    var uri = apiTemplate.BindByPosition(new Uri(apiBase, UriKind.Absolute), componentName, itemName);
    this.TestContext.WriteLine(&quot;uri: {0}&quot;, uri);
    var request = ((HttpWebRequest)WebRequest.Create(uri));
    request.Method = &quot;DELETE&quot;;
    request.Accept = MimeTypes.ApplicationJson;
    request.ContentType = MimeTypes.ApplicationJson;
    request.Headers.Add(&quot;api-key&quot;, apiKey);
    var code = request.ToHttpStatusCode();
    this.TestContext.WriteLine(&quot;HttpStatusCode: {0}&quot;, code);
    Assert.IsTrue(code == HttpStatusCode.NoContent, &quot;The expected status code is not here.&quot;);
}
</code></pre>
<p>For details on where apiKey comes from, see “<a href="https://azure.microsoft.com/en-us/documentation/articles/search-query-rest-api/">Query your Azure Search index using the REST API</a>” by Ashish Makadia. So without the .NET ceremony a <code>DELETE</code> looks like this:</p>
<pre><code class="language-plaintext">https://my-azure.search.windows.net/{componentName}/{itemName}?api-version=2015-02-28-Preview
</code></pre>
<p>…where <code>componentName</code> represents our three ‘components’, <code>datasources</code>, <code>indexers</code> and <code>indexes</code>, and <code>itemName</code> is your name of the ‘component.’</p>
<p>When we change this line:</p>
<pre><code class="language-c#">request.Method = &quot;DELETE&quot;;
</code></pre>
<p>…to this:</p>
<pre><code class="language-c#">request.Method = &quot;GET&quot;;
</code></pre>
<p>Our <code>DELETE</code> changes to a <code>GET</code>—so the URI above can be used for <code>GET</code> operations to verify that our <code>POST</code> operations are working. I am sure, by the way, that <code>PUT</code> is supported here but I did not want to bother Eugene about this (see “<a href="https://msdn.microsoft.com/library/azure/dn798935.aspx">Azure Search Service REST</a>”—this might be of help).</p>
<h2>POST of a new Azure-Blob Data Source</h2>
<p>We have already seen that <code>DELETE</code> and <code>GET</code> operations can be shared. It should be no surprise that all of our <code>POST</code> operations are the same—the only thing that changes is the JSON “body.” In the screenshot below, I have highlighted the <code>json</code> variable—being passed to my not-required-at-all, custom extension method <code>WithRequestBody()</code>:
<a href="https://www.flickr.com/photos/wilhite/26981648063/in/dateposted-public/" title="Azure Search of JSON Blobs"><img alt="Azure Search of JSON Blobs" src="https://farm8.staticflickr.com/7561/26981648063_180d8cf85f_z_d.jpg"></a></p>
<p>So, the important piece is not shown above is the JSON in the <code>POST</code>:</p>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;songhayblog-datasource&quot;,
    &quot;type&quot;: &quot;azureblob&quot;,
    &quot;credentials&quot;: { &quot;connectionString&quot;: &quot;[copy and paste from Portal]&quot; },
    &quot;container&quot;: {
        &quot;name&quot;: &quot;songhayblog-azurewebsites-net&quot;,
        &quot;query&quot;: &quot;BlogEntry&quot;
    }
}
</code></pre>
<p>For details on where <code>connectionString</code> comes from, see “<a href="https://msblogs.wordpress.com/tag/connection-string-to-azure-storage-account/">Windows Azure—Configuring Storage Accounts</a>” by Biju Paulose. The rest of these JSON properties are covered by Eugene in “<a href="https://azure.microsoft.com/en-us/documentation/articles/search-howto-indexing-azure-blob-storage/">Indexing Documents in Azure Blob Storage with Azure Search</a>.”</p>
<p>The response from the Azure Search API looks like this:
<a href="https://www.flickr.com/photos/wilhite/26980552954/in/dateposted-public/" title="Azure Search of JSON Blobs"><img alt="Azure Search of JSON Blobs" src="https://farm8.staticflickr.com/7709/26980552954_b9ae4b65e5_z_d.jpg"></a></p>
<h2>POST of a new Azure-Blob Index</h2>
<p>This is the JSON payload for generating a new Index:</p>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;songhayblog-index&quot;,
    &quot;fields&quot;: [
        {
            &quot;name&quot;: &quot;Slug&quot;,
            &quot;type&quot;: &quot;Edm.String&quot;,
            &quot;key&quot;: true,
            &quot;searchable&quot;: false
        },
        {
            &quot;name&quot;: &quot;Content&quot;,
            &quot;type&quot;: &quot;Edm.String&quot;,
            &quot;searchable&quot;: true
        },
        {
            &quot;name&quot;: &quot;Title&quot;,
            &quot;type&quot;: &quot;Edm.String&quot;,
            &quot;searchable&quot;: true
        }
    ]
}
</code></pre>
<p>The <code>fields</code> of this Index refer to the JSON shape that represents the <code>BlogEntry</code> object that defines the Blog entries for the Blog you are reading now:</p>
<pre><code class="language-json">{
  &quot;Author&quot;: &quot;Bryan Wilhite&quot;,
  &quot;Content&quot;: &quot;&lt;p&gt;I would like to thank &lt;a href=\&quot;https://twitter.com/chaosrealm4\&quot;&gt;Microsoft’s Eugene Shvets&lt;/a&gt; for helping me [XHTML truncated]&quot;,
  &quot;InceptDate&quot;: &quot;2016-06-13T21:42:54.1078686-07:00&quot;,
  &quot;IsPublished&quot;: true,
  &quot;ItemCategory&quot;: null,
  &quot;ModificationDate&quot;: &quot;0001-01-01T00:00:00&quot;,
  &quot;Slug&quot;: &quot;setting-up-an-azure-search-json-blob-indexer-with-api-version-2015-02-28-preview&quot;,
  &quot;SortOrdinal&quot;: 0,
  &quot;Tag&quot;: null,
  &quot;Title&quot;: &quot;Setting up an @Azure Search JSON blob Indexer with api-version=2015-02-28-Preview&quot;
}
</code></pre>
<h2>POST of a new Azure-Blob Indexer</h2>
<p>The Indexer is what ‘fills’ the Index, starting the “crawl” of the Azure Blob Container. In the <code>POST</code> JSON payload, we see it targeting the index named above, using a schedule interval I copied from Eugene:</p>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;songhayblog-indexer&quot;,
    &quot;dataSourceName&quot;: &quot;songhayblog-datasource&quot;,
    &quot;parameters&quot;: { &quot;configuration&quot;: { &quot;useJsonParser&quot;: true } },
    &quot;targetIndexName&quot;: &quot;songhayblog-index&quot;,
    &quot;schedule&quot;: { &quot;interval&quot;: &quot;PT2H&quot; }
}
</code></pre>
<h2>In case you care about this HttpWebRequest stuff…</h2>
<p>My <code>HttpWebRequest</code> stuff here is not “confusing” it is more likely to be considered “old” (compared to the async-only <code>HttpClient</code>)—but experience informs me that this “old” stuff is backwards compatible. So I have made investments in a few extension methods around <code>HttpWebRequest</code> :</p>
<script src="https://gist.github.com/BryanWilhite/b04945418a6635e754e3.js"></script>
<h2>Related Links</h2>
<ul>
<li>“<a href="https://msdn.microsoft.com/library/azure/dn798935.aspx">Azure Search Service REST</a>”</li>
<li>“<a href="https://azure.microsoft.com/en-us/documentation/articles/search-howto-indexing-azure-blob-storage/">Indexing Documents in Azure Blob Storage with Azure Search</a>” by Eugene Shvets</li>
<li>“<a href="https://azure.microsoft.com/en-us/documentation/articles/search-get-started-portal/">Get started with Azure Search in the portal</a>” by Heidi Steen</li>
<li>“<a href="https://azure.microsoft.com/en-us/documentation/articles/search-query-rest-api/">Query your Azure Search index using the REST API</a>” by Ashish Makadia</li>
</ul>
<p>@<a href="https://twitter.com/BryanWilhite">BryanWilhite</a></p>


</section>
<section class="meta">
    <span class="entry-date"> <strong>incept date:</strong> EEEE, MMMM d, y </span>
</section>
        </main>
        <footer>
            <div class="col-sm-8">
                <p>
                    Last Reviewed:
                    2016-06-14T04:42:54.107Z
                </p>
                <p>
                    Another stone tribal move by <a class="welcome" href="http://songhaysystem.com/">Songhay System</a>
                </p>
            </div>
            <div class="col-sm-4">
                <a href="http://twitter.com/BryanWilhite" target="_blank" title="@BryanWilhite">
                    <span class="zocial twitter icon"></span>
                </a>
                <a href="http://songhayblog.azurewebsites.net/entry/feed.xml" target="_blank" title="Atom feed">
                    <span class="zocial rss icon"></span>
                </a>
            </div>
        </footer>
    </body>

</html>