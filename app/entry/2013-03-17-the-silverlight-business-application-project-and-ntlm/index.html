<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <meta name="description" content="my technical Blog ✒ for my studio" />
        <meta name="robots" content="index, follow" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <meta name="google-site-verification" content="MyXJp0qYgoTSi472GCarwPFWqvRZAo8khVV_FXV33tI" />
        <meta name="msvalidate.01" content="9C08B066B4967EBE515E0CC7C146DE30" />

        <base href="http://songhayblog.azurewebsites.net/" />

        <link rel="canonical" href="http://songhayblog.azurewebsites.net/" />
        <link rel="alternate" type="application/atom+xml" title="day path" href="/entry/feed.xml" />
        <link rel="SHORTCUT ICON" href="http://songhayblog.azurewebsites.net/image/favicon.ico" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
        <link href="http://songhayblog.azurewebsites.net/style/styles.min.css" rel="stylesheet" />

        <script src="http://songhayblog.azurewebsites.net/script/index.min.js"></script>

        <title>The “Silverlight Business Application” Project and NTLM - day path</title>
    </head>

    <body class="mdc-typography">
        <header class="mdc-top-app-bar mdc-top-app-bar--short">
            <div class="mdc-top-app-bar__row">
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                    <a href="http://songhayblog.azurewebsites.net/" class="material-icons mdc-top-app-bar__navigation-icon">first_page</a>
                    <span class="mdc-top-app-bar__title">day path</span>
                </section>
                <section class="description mdc-top-app-bar__section mdc-top-app-bar__section--align-end">
                    my technical Blog ✒ for my studio
                </section>
            </div>
        </header>
        <main class="mdc-layout-grid" id="main-content">
            <section class="entry">

    <h1>The “Silverlight Business Application” Project and NTLM</h1>
<p>One very important detail that the classic “<a href="http://msdn.microsoft.com/en-us/library/ee707360(v=vs.91).aspx">Silverlight Business Application</a>” project has to teach us is how to use old-school <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa378749(v=vs.85).aspx">NTLM</a> authentication with Silverlight. This is a well-established but not very versatile/scalable way to authenticate users. In the real world of the corporate enterprise, NTLM is the only way to go. The assumption today is that there are authentication alternatives that Microsoft would encourage such as <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa378747(v=vs.85).aspx">Microsoft Kerberos</a> or maybe <a href="http://msdn.microsoft.com/en-us/library/ff647400.aspx">Active Directory Application Mode (ADAM)</a>. The leading constraint on these Authentication alternatives is what ASP.NET supports out of the box. The other leading constraint would be a requirement that authentication depends on Active Directory as is—no domain-level modification, no LDAP-level customizations—and no secondary set of users to authenticate outside of Active Directory (stored in a database).</p>
<p>One unexpected takeaway from these notes is the assertion that we cannot have NTLM authentication without setting up ‘default’ ASP.NET profiles. The <em>defacto</em> default ASP.NET profile is represented by <code>AspNetSqlProfileProvider</code>. This implies that a SQL Server database is <em>required</em> to use NTLM—which seems very strange, encouraging us to look forward to finding out that the above assertion is incorrect.</p>
<h2>Setting up NTLM Authentication</h2>
<p>In conventional Silverlight <code>App</code> constructor, state:</p>
<pre><code class="language-c#">var webContext = new WebContext();
webContext.Authentication = new WindowsAuthentication();
this.ApplicationLifetimeObjects.Add(webContext);
</code></pre>
<p>In <code>App.Startup</code>, state:</p>
<pre><code class="language-c#">WebContext.Current.Authentication.LoadUser(
        operation =&gt; Messenger.Default.Send(operation), null);
</code></pre>
<p>The MVVM Light Messenger expects this registration:</p>
<pre><code class="language-c#">Messenger.Default.Register&lt;LoadUserOperation&gt;(this,
    operation =&gt;
    {
        if (operation.HasError) return; //TODO: handle LoadUser() error.
        if (operation.User == null) return;
        var user = WebContext.Current.Authentication.User;
        this.CurrentUserName = user.Identity.GetWindowsUserName();
    });
</code></pre>
<p>…where <code>Identity.GetWindowsUserName()</code> is from <a href="http://pastebin.com/hmmEMmpg">a custom extension method</a>.</p>
<p>In the <code>system.web</code> node of <code>web.config</code>, declare:</p>
<pre><code class="language-xml">&lt;authorization&gt;
        &lt;deny users=&quot;?&quot;/&gt;
    &lt;/authorization&gt;

&lt;authentication mode=&quot;Windows&quot; /&gt;
    &lt;membership&gt;
        &lt;providers&gt;
            &lt;clear/&gt;
        &lt;/providers&gt;
    &lt;/membership&gt;
    &lt;roleManager enabled=&quot;false&quot;&gt;
        &lt;providers&gt;
            &lt;clear/&gt;
        &lt;/providers&gt;
    &lt;/roleManager&gt;
    &lt;profile&gt;
        &lt;providers&gt;
            &lt;clear/&gt;
            &lt;add name=&quot;AspNetSqlProfileProvider&quot;
                type=&quot;System.Web.Profile.SqlProfileProvider&quot;
                 connectionStringName=&quot;ApplicationServices&quot;
                 applicationName=&quot;./&quot; /&gt;
        &lt;/providers&gt;
    &lt;/profile&gt;
</code></pre>
<p>…where <code>connectionStringName=&quot;ApplicationServices&quot;</code> refers to:</p>
<pre><code class="language-xml">&lt;add name=&quot;ApplicationServices&quot; connectionString=&quot;Data Source=MyDbServer;Initial Catalog=MyDb;User ID=MyUser;Password=my!pwd;MultipleActiveResultSets=true&quot; /&gt;
</code></pre>
<p>…where the Data Source contains tables setup by the <code>aspnet_regsql.exe</code> tool, covered in “<a href="http://weblogs.asp.net/sukumarraju/archive/2009/10/02/installing-asp-net-membership-services-database-in-sql-server-expreess.aspx">Installing ASP.NET Membership services database in SQL Server Express 2008</a>.” (An attempt to avoid doing all of this work with the <code>AspNetSqlProfileProvider</code>, might lead one to use the <code>System.Web.Security.WindowsTokenRoleProvider</code>, I found ne success here.)</p>
<h2>Setting up WCF over NTLM</h2>
<p>Visual studio will automatically generate <code>ServiceReferences.ClientConfig</code> during the <strong>Add Service Reference…</strong> process. In the <code>configuration\system.serviceModel</code> node of this document we might have this declaration:</p>
<pre><code class="language-xml">&lt;bindings&gt;
    &lt;basicHttpBinding&gt;
        &lt;binding name=&quot;BasicHttpBinding&quot;
            maxBufferSize=&quot;2147483647&quot;
            maxReceivedMessageSize=&quot;2147483647&quot;&gt;
            &lt;security mode=&quot;None&quot; /&gt;
        &lt;/binding&gt;
    &lt;/basicHttpBinding&gt;
&lt;/bindings&gt;
</code></pre>
<p>To support NTLM, declare:</p>
<pre><code class="language-xml">&lt;bindings&gt;
    &lt;basicHttpBinding&gt;
        &lt;binding name=&quot;BasicHttpBinding&quot;
            maxBufferSize=&quot;2147483647&quot;
            maxReceivedMessageSize=&quot;2147483647&quot;&gt;
            &lt;security mode=&quot;TransportCredentialOnly&quot; /&gt;
        &lt;/binding&gt;
    &lt;/basicHttpBinding&gt;
&lt;/bindings&gt;
</code></pre>
<p>Visual studio will automatically generate a <code>system.serviceModel</code> node in <code>web.config</code>, during the <strong>Add Service Reference…</strong> process. We must add a binding in <code>system.serviceModel\bindings</code> to complement the one declared for the Client in <code>ServiceReferences.ClientConfig</code>:</p>
<pre><code class="language-xml">&lt;bindings&gt;
    &lt;basicHttpBinding&gt;
        &lt;binding&gt;
            &lt;security mode=&quot;TransportCredentialOnly&quot;&gt;
                &lt;transport clientCredentialType=&quot;Windows&quot;/&gt;
            &lt;/security&gt;
        &lt;/binding&gt;
    &lt;/basicHttpBinding&gt;
&lt;/bindings&gt;
</code></pre>
<h2>Setting up “Classic” NTLM Authentication on IIS 7.x</h2>
<ul>
<li>Select <strong>Authentication</strong> from the Features View of Internet Information Services (IIS) Manager.</li>
<li>Disable <strong>Anonymous Authentication</strong> (and all other forms of authentication).</li>
<li>Enable <strong>Windows Authentication</strong> and select <strong>Providers…</strong> In the <strong>Providers</strong> dialog, move NTLM to the top of <strong>Enabled Providers</strong>.</li>
</ul>
<h2>Related Links</h2>
<ul>
<li>“<a href="http://msdn.microsoft.com/en-us/library/ee707360(v=vs.91).aspx">Walkthrough: Using the Silverlight Business Application Template</a>”</li>
<li>“<a href="http://weblogs.asp.net/sukumarraju/archive/2009/10/02/installing-asp-net-membership-services-database-in-sql-server-expreess.aspx">Installing ASP.NET Membership services database in SQL Server Express 2008—Sukumar Raju’s Blog</a>”</li>
<li>“<a href="http://www.christowles.com/2011/04/aspnet-forms-based-authentication-with.html">ASP.NET Forms Based Authentication with Active Directory</a>”</li>
<li>“<a href="http://social.msdn.microsoft.com/Forums/en-US/silverlightarchieve/thread/a565b6aa-e791-47f3-a472-223f379b7788/">RIA Services fallback from WindowsAuthentication to FormsAuthentication?</a>”</li>
<li>“<a href="http://blogs.msdn.com/b/ieinternals/archive/2011/07/06/integrated-windows-authentication-kerberos-ntlm-http-400-error-for-16kb-authorization-header.aspx">Integrated Windows Authentication</a>”</li>
<li>“<a href="http://www.codinghorror.com/blog/2005/04/aspnet-ntlm-authentication---is-it-worth-it.html">ASP.NET NTLM Authentication—is it worth it?</a>”</li>
</ul>
<p>@<a href="https://twitter.com/BryanWilhite">BryanWilhite</a></p>


</section>
<section class="meta">
    <span class="entry-date"> <strong>incept date:</strong> EEEE, MMMM d, y </span>
</section>
        </main>
        <footer>
            <div class="col-sm-8">
                <p>
                    Last Reviewed:
                    2013-03-18T00:00:00.000Z
                </p>
                <p>
                    Another stone tribal move by <a class="welcome" href="http://songhaysystem.com/">Songhay System</a>
                </p>
            </div>
            <div class="col-sm-4">
                <a href="http://twitter.com/BryanWilhite" target="_blank" title="@BryanWilhite">
                    <span class="zocial twitter icon"></span>
                </a>
                <a href="http://songhayblog.azurewebsites.net/entry/feed.xml" target="_blank" title="Atom feed">
                    <span class="zocial rss icon"></span>
                </a>
            </div>
        </footer>
    </body>

</html>